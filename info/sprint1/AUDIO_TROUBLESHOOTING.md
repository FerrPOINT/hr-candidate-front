# Диагностика проблем с передачей аудио

## Обзор проблемы

Данный документ содержит профессиональный анализ возможных причин проблем с передачей аудио файлов в приложении HR Recruiter.

## Новые возможности усиления микрофона (v2.0)

### Автоматическое усиление микрофона

Приложение теперь включает комплексную систему усиления микрофона для улучшения качества транскрибации:

#### 1. Аудио цепочка обработки
- **High-pass фильтр (80Hz)**: Убирает низкочастотные помехи
- **Notch фильтр (50Hz)**: Убирает сетевые помехи
- **Компрессор (4:1)**: Улучшает динамический диапазон
- **Gain node**: Автоматическое усиление (1.0x - 5.0x)
- **Low-pass фильтр (8kHz)**: Убирает высокочастотные шумы

#### 2. Динамическое усиление
- Автоматическая настройка усиления на основе уровня звука
- Целевой уровень: 50% от максимального
- Плавное изменение без искажений

#### 3. Улучшенные настройки записи
- Частота дискретизации: 48kHz
- Монофоническая запись (лучше для речи)
- Кодек: WebM/Opus (оптимален для речи)

#### 4. Визуальная обратная связь
- Цветовая индикация качества (красный/желтый/зеленый)
- Отображение текущего усиления
- Индикатор уровня звука в реальном времени

### Рекомендации для пользователей

#### Для лучшего качества записи:
1. **Позиционирование микрофона**:
   - Держитесь на расстоянии 15-30 см от микрофона
   - Говорите прямо в микрофон
   - Избегайте дыхания в микрофон

2. **Окружающая среда**:
   - Выберите тихое помещение
   - Закройте окна и двери
   - Отключите вентиляторы и кондиционеры

3. **Настройки системы**:
   - Убедитесь, что выбран правильный микрофон
   - Проверьте уровень громкости микрофона в системе
   - Отключите другие приложения, использующие микрофон

4. **Техника речи**:
   - Говорите четко и с нормальной скоростью
   - Делайте паузы между предложениями
   - Избегайте шепота или крика

## Возможные причины проблем

### 1. Проблемы с CORS (Cross-Origin Resource Sharing)

**Симптомы:**
- Ошибки в консоли браузера типа "CORS policy blocked"
- Запросы не доходят до сервера
- Ошибки 403 Forbidden

**Решение:**
- Добавлен файл `src/setupProxy.js` для проксирования запросов в режиме разработки
- Настроены CORS заголовки в прокси

### 2. Проблемы с размером файла

**Симптомы:**
- Ошибки "Request entity too large"
- Запросы прерываются
- Пустые ответы от сервера

**Решение:**
- Добавлены проверки размера файла (максимум 50MB)
- Проверка на пустые файлы
- Логирование размера файла

### 3. Проблемы с форматом аудио

**Симптомы:**
- Ошибки "Unsupported media type"
- Сервер не может обработать файл
- Проблемы с кодеками

**Решение:**
- Используется формат WebM с кодеком Opus
- Fallback на стандартные настройки MediaRecorder
- Проверка поддержки кодеков браузером

### 4. Проблемы с аутентификацией

**Симптомы:**
- Ошибки 401 Unauthorized
- Проблемы с Basic Auth
- Неправильные заголовки авторизации

**Решение:**
- Проверка настроек Basic Auth в конфигурации
- Правильная передача username/password

### 5. Проблемы с сетевым подключением

**Симптомы:**
- Таймауты запросов
- Ошибки сети
- Медленная передача

**Решение:**
- Добавлено логирование всех этапов передачи
- Проверка доступности сервера

## Инструменты диагностики

### 1. Тестовый компонент AudioTest

Доступен по адресу `/audio-test` для изолированного тестирования передачи аудио.

**Функции:**
- Запись аудио
- Тест простой транскрибации
- Тест транскрибации интервью
- Отображение размера файла
- Подробное логирование

### 2. Улучшенное логирование

Добавлено детальное логирование во всех критических точках:

- Размер и тип аудио файла
- Детали HTTP запросов
- Ответы сервера
- Ошибки с полным стеком

### 3. Проверки качества

- Проверка размера файла
- Проверка на пустые файлы
- Валидация формата
- Проверка поддержки браузером

## Пошаговая диагностика

### Шаг 1: Проверка браузера
1. Откройте `/audio-test`
2. Проверьте поддержку MediaRecorder
3. Проверьте доступ к микрофону

### Шаг 2: Проверка записи
1. Запишите короткий аудио фрагмент
2. Проверьте размер файла
3. Убедитесь, что файл не пустой

### Шаг 3: Проверка передачи
1. Запустите тест транскрибации
2. Проверьте консоль браузера на ошибки
3. Проверьте Network tab в DevTools

### Шаг 4: Проверка сервера
1. Убедитесь, что сервер запущен на порту 8080
2. Проверьте доступность `/api/ai/transcribe`
3. Проверьте логи сервера

## Логи для анализа

### Клиентские логи
```javascript
// В консоли браузера искать:
=== TRANSCRIBE AUDIO SERVICE START ===
=== TRANSCRIBE AUDIO SERVICE ERROR ===
=== TRANSCRIBE INTERVIEW ANSWER SERVICE START ===
=== TRANSCRIBE INTERVIEW ANSWER SERVICE ERROR ===
```

### Серверные логи
- Проверять логи сервера на ошибки обработки файлов
- Проверять размеры принимаемых файлов
- Проверять ошибки аутентификации

## Частые проблемы и решения

### Проблема: "Audio file is empty"
**Причина:** Неправильная запись или обработка аудио
**Решение:** Проверить настройки MediaRecorder и обработчики событий

### Проблема: "CORS policy blocked"
**Причина:** Отсутствие CORS заголовков на сервере
**Решение:** Использовать setupProxy.js или настроить CORS на сервере

### Проблема: "Request entity too large"
**Причина:** Файл превышает лимит сервера
**Решение:** Уменьшить качество записи или увеличить лимит на сервере

### Проблема: "Unsupported media type"
**Причина:** Неподдерживаемый формат аудио
**Решение:** Использовать WebM с Opus кодеком

## Рекомендации по исправлению

1. **Всегда проверяйте консоль браузера** - там содержится основная информация об ошибках
2. **Используйте тестовый компонент** - для изолированного тестирования
3. **Проверяйте размер файла** - убедитесь, что файл не пустой и не слишком большой
4. **Проверяйте сетевые запросы** - используйте Network tab в DevTools
5. **Логируйте все этапы** - добавленное логирование поможет найти проблему

## Контакты для поддержки

При возникновении проблем:
1. Соберите логи из консоли браузера
2. Сделайте скриншот ошибок
3. Укажите версию браузера и ОС
4. Опишите шаги для воспроизведения проблемы

# Устранение проблем с аудио

## Проблема: "getUserMedia not supported"

### Причины:
1. **Браузер не поддерживает Web Audio API**
2. **Сайт открыт не по HTTPS** (в современных браузерах getUserMedia требует HTTPS)
3. **Браузер устарел**

### Решения:

#### 1. Проверьте браузер
- Используйте **Chrome 47+**, **Firefox 44+**, **Safari 11+**, **Edge 12+**
- Обновите браузер до последней версии

#### 2. Проверьте протокол
- Сайт должен быть открыт по **HTTPS** (не HTTP)
- Для локальной разработки используйте `localhost` (разрешен без HTTPS)

#### 3. Проверьте настройки браузера
- Разрешите доступ к микрофону в настройках браузера
- Проверьте, не заблокирован ли доступ к микрофону

## Проблема: "Доступ к микрофону запрещен"

### Решения:

#### 1. Разрешите доступ в браузере
- Нажмите на иконку замка/щита в адресной строке
- Разрешите доступ к микрофону
- Перезагрузите страницу

#### 2. Проверьте системные настройки
**Windows:**
- Настройки → Конфиденциальность → Микрофон
- Включите "Разрешить приложениям доступ к микрофону"

**macOS:**
- Системные настройки → Безопасность и конфиденциальность → Микрофон
- Разрешите доступ для браузера

**Linux:**
- Проверьте настройки PulseAudio или ALSA

## Проблема: "Микрофон не найден"

### Решения:

#### 1. Проверьте подключение
- Убедитесь, что микрофон подключен
- Проверьте, что он не отключен в системе

#### 2. Проверьте системные настройки
**Windows:**
- Правый клик на значке звука → Звуки
- Вкладка "Запись" → выберите нужный микрофон

**macOS:**
- Системные настройки → Звук → Вход
- Выберите нужный микрофон

**Linux:**
- Проверьте настройки аудио системы

## Проблема: "Микрофон занят другим приложением"

### Решения:

#### 1. Закройте другие приложения
- Закройте Skype, Discord, Zoom и другие приложения
- Проверьте, не записывает ли что-то еще

#### 2. Перезапустите браузер
- Полностью закройте браузер
- Откройте заново

## Проблема: "Ошибка записи аудио"

### Решения:

#### 1. Проверьте поддержку кодеков
- Браузер должен поддерживать хотя бы один из кодеков:
  - `audio/webm;codecs=opus` (рекомендуется)
  - `audio/webm`
  - `audio/ogg;codecs=opus`
  - `audio/mp4`
  - `audio/wav`

#### 2. Обновите браузер
- Устаревшие браузеры могут не поддерживать современные аудио кодеков

## Тестирование аудио

### Используйте тестовый файл
Откройте `src/test-audio.html` в браузере для проверки:
1. Поддержки браузера
2. Доступа к микрофону
3. Записи аудио

### Пошаговая проверка:
1. Нажмите "Проверить поддержку"
2. Нажмите "Запросить разрешение"
3. Нажмите "Начать запись"
4. Говорите в микрофон
5. Нажмите "Остановить запись"
6. Проверьте воспроизведение

## Советы для лучшей записи

### 1. Окружение
- Используйте тихое помещение
- Избегайте эха и фонового шума
- Держитесь ближе к микрофону

### 2. Настройки микрофона
- Установите оптимальную громкость
- Проверьте качество микрофона
- Используйте внешний микрофон для лучшего качества

### 3. Браузер
- Используйте последнюю версию Chrome или Edge
- Отключите расширения, которые могут блокировать микрофон
- Очистите кэш браузера

## Техническая информация

### Поддерживаемые браузеры:
- **Chrome 47+** (рекомендуется)
- **Firefox 44+**
- **Safari 11+**
- **Edge 12+**

### Поддерживаемые аудио форматы:
- **WebM с Opus** (лучшее качество)
- **WebM** (универсальный)
- **Ogg с Opus** (альтернатива)
- **MP4** (широкая поддержка)
- **WAV** (без сжатия)

### Настройки аудио:
```javascript
{
  audio: {
    echoCancellation: true,    // Подавление эха
    noiseSuppression: true,    // Подавление шума
    autoGainControl: true      // Автоматическое усиление
  }
}
```

## Если ничего не помогает

1. **Попробуйте другой браузер**
2. **Проверьте на другом устройстве**
3. **Обратитесь к системному администратору**
4. **Проверьте корпоративные политики безопасности** 